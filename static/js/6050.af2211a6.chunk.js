"use strict";(self.webpackChunkwanlok_component_react=self.webpackChunkwanlok_component_react||[]).push([[6050],{70373:(e,t,i)=>{i.d(t,{w:()=>s});var n=i(18690),a=i(30015),o=i(61196);class s{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,t=arguments.length>1?arguments[1]:void 0;this._compareMinX=d,this._compareMinY=u,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),M.prune(),_.prune(),x.prune(),b.prune()}all(e){this._all(this._data,e)}search(e,t){let i=this._data;const n=this._toBBox;if(g(e,i))for(M.clear();i;){for(let a=0,o=i.children.length;a<o;a++){const o=i.children[a],s=i.leaf?n(o):o;g(e,s)&&(i.leaf?t(o):f(e,s)?this._all(o,t):M.push(o))}i=M.pop()}}collides(e){let t=this._data;const i=this._toBBox;if(!g(e,t))return!1;for(M.clear();t;){for(let n=0,a=t.children.length;n<a;n++){const a=t.children[n],o=t.leaf?i(a):a;if(g(e,o)){if(t.leaf||f(e,o))return!0;M.push(a)}}t=M.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}let t=this._build(e.slice(0,e.length),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){const e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new L([]),this}remove(e){if(!e)return this;let t,i=this._data,a=null,o=0,s=!1;const r=this._toBBox(e);for(x.clear(),b.clear();i||x.length>0;){var l;if(i||(i=x.pop(),a=x.data[x.length-1],o=null!==(l=b.pop())&&void 0!==l?l:0,s=!0),i.leaf&&(t=(0,n.qh)(i.children,e,i.children.length,i.indexHint),-1!==t))return i.children.splice(t,1),x.push(i),this._condense(x),this;s||i.leaf||!f(i,r)?a?(o++,i=a.children[o],s=!1):i=null:(x.push(i),b.push(o),o=0,a=i,i=i.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_all(e,t){let i=e;for(_.clear();i;){var n;if(!0===i.leaf)for(const e of i.children)t(e);else _.pushArray(i.children);i=null!==(n=_.pop())&&void 0!==n?n:null}}_build(e,t,i,n){const a=i-t+1;let o=this._maxEntries;if(a<=o){const n=new L(e.slice(t,i+1));return r(n,this._toBBox),n}n||(n=Math.ceil(Math.log(a)/Math.log(o)),o=Math.ceil(a/o**(n-1)));const s=new k([]);s.height=n;const l=Math.ceil(a/o),h=l*Math.ceil(Math.sqrt(o));v(e,t,i,h,this._compareMinX);for(let r=t;r<=i;r+=h){const t=Math.min(r+h-1,i);v(e,r,t,l,this._compareMinY);for(let i=r;i<=t;i+=l){const a=Math.min(i+l-1,t);s.children.push(this._build(e,i,a,n-1))}}return r(s,this._toBBox),s}_chooseSubtree(e,t,i,n){for(;n.push(t),!0!==t.leaf&&n.length-1!==i;){let i,n=1/0,a=1/0;for(let o=0,s=t.children.length;o<s;o++){const s=t.children[o],r=p(s),l=y(e,s)-r;l<a?(a=l,n=r<n?r:n,i=s):l===a&&r<n&&(n=r,i=s)}t=i||t.children[0]}return t}_insert(e,t,i){const n=this._toBBox,a=i?e:n(e);x.clear();const o=this._chooseSubtree(a,this._data,t,x);for(o.children.push(e),h(o,a);t>=0&&x.data[t].children.length>this._maxEntries;)this._split(x,t),t--;this._adjustParentBBoxes(a,x,t)}_split(e,t){const i=e.data[t],n=i.children.length,a=this._minEntries;this._chooseSplitAxis(i,a,n);const o=this._chooseSplitIndex(i,a,n);if(!o)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const s=i.children.splice(o,i.children.length-o),l=i.leaf?new L(s):new k(s);l.height=i.height,r(i,this._toBBox),r(l,this._toBBox),t?e.data[t-1].children.push(l):this._splitRoot(i,l)}_splitRoot(e,t){this._data=new k([e,t]),this._data.height=e.height+1,r(this._data,this._toBBox)}_chooseSplitIndex(e,t,i){let n,a,o;n=a=1/0;for(let s=t;s<=i-t;s++){const t=l(e,0,s,this._toBBox),r=l(e,s,i,this._toBBox),h=m(t,r),d=p(t)+p(r);h<n?(n=h,o=s,a=d<a?d:a):h===n&&d<a&&(a=d,o=s)}return o}_chooseSplitAxis(e,t,i){const n=e.leaf?this._compareMinX:d,a=e.leaf?this._compareMinY:u;this._allDistMargin(e,t,i,n)<this._allDistMargin(e,t,i,a)&&e.children.sort(n)}_allDistMargin(e,t,i,n){e.children.sort(n);const a=this._toBBox,o=l(e,0,t,a),s=l(e,i-t,i,a);let r=c(o)+c(s);for(let l=t;l<i-t;l++){const t=e.children[l];h(o,e.leaf?a(t):t),r+=c(o)}for(let l=i-t-1;l>=t;l--){const t=e.children[l];h(s,e.leaf?a(t):t),r+=c(s)}return r}_adjustParentBBoxes(e,t,i){for(let n=i;n>=0;n--)h(t.data[n],e)}_condense(e){for(let t=e.length-1;t>=0;t--){const i=e.data[t];if(0===i.children.length)if(t>0){const a=e.data[t-1],o=a.children;o.splice((0,n.qh)(o,i,o.length,a.indexHint),1)}else this.clear();else r(i,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this._compareMinX=new Function("a","b",t.join(e[0])),this._compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function r(e,t){l(e,0,e.children.length,t,e)}function l(e,t,i,n,a){a||(a=new L([])),a.minX=1/0,a.minY=1/0,a.maxX=-1/0,a.maxY=-1/0;for(let o,s=t;s<i;s++)o=e.children[s],h(a,e.leaf?n(o):o);return a}function h(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function d(e,t){return e.minX-t.minX}function u(e,t){return e.minY-t.minY}function p(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function c(e){return e.maxX-e.minX+(e.maxY-e.minY)}function y(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function m(e,t){const i=Math.max(e.minX,t.minX),n=Math.max(e.minY,t.minY),a=Math.min(e.maxX,t.maxX),o=Math.min(e.maxY,t.maxY);return Math.max(0,a-i)*Math.max(0,o-n)}function f(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function g(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function v(e,t,i,n,a){const s=[t,i];for(;s.length;){const t=s.pop(),i=s.pop();if(t-i<=n)continue;const r=i+Math.ceil((t-i)/n/2)*n;(0,o.q)(e,r,i,t,a),s.push(i,r,r,t)}}const M=new a.A,_=new a.A,x=new a.A,b=new a.A({deallocator:void 0});class T{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class w extends T{constructor(){super(...arguments),this.height=1,this.indexHint=new n.vW}}class L extends w{constructor(e){super(),this.children=e,this.leaf=!0}}class k extends w{constructor(e){super(),this.children=e,this.leaf=!1}}},26486:(e,t,i)=>{i.d(t,{Hq:()=>b,Qj:()=>w,V2:()=>m,m_:()=>f});i(81806);var n=i(15941),a=i(76797),o=i(65215),s=i(13312),r=i(14556),l=i(98618),h=i(1484),d=i(24586);const u=new Float64Array(2),p=new Float64Array(2),c="0123456789bcdefghjkmnpqrstuvwxyz",y=64;function m(e,t,i,n){const r=[e.xmin,e.ymin,e.xmax,e.ymax],u=o.A.fromExtent(a.A.fromBounds(r,n)),p=(0,d.Cv)(u,n,s.A.WGS84,{densificationStep:t*y});if(!p)return null;const c=(0,l.Ye)(new h.A,p,!1,!1),m=c.coords.filter(((e,t)=>!(t%2))),g=c.coords.filter(((e,t)=>t%2)),v=Math.min(...m),M=Math.min(...g),_=Math.max(...m),x=Math.max(...g),b=f(v,M,i,s.A.WGS84),T=f(_,x,i,s.A.WGS84);return b&&T?{bounds:r,geohashBounds:{xLL:b[0],yLL:b[1],xTR:T[0],yTR:T[1]},level:i}:null}function f(e,t,i,a){if(a.isWebMercator){const a=(0,n.KJ)(e/r.$O.radius),o=a-360*Math.floor((a+180)/360),s=[0,0];return T(s,0,(0,n.KJ)(Math.PI/2-2*Math.atan(Math.exp(-t/r.$O.radius))),o,i),s}const o=(0,d.Cv)({x:e,y:t},a,s.A.WGS84);if(!o)return null;const l=[0,0];return T(l,0,o.y,o.x,i),l}function g(e){return c[e]}function v(e){return(e[0]+e[1])/2}function M(e,t,i){return e[0]=t,e[1]=i,e}function _(e,t){const i=v(e),n=t,a=!t;e[0]=a*e[0]+n*i,e[1]=a*i+n*e[1]}function x(e,t){const i=t>v(e);return _(e,i),i}function b(e,t){let i=-90,n=90,a=-180,o=180;for(let s=0;s<t;s++){const t=Math.ceil((s+1)/2),r=Math.floor((s+1)/2),l=1-s%2,h=30-(3*t+2*r),d=30-(2*t+3*r),u=3*l+2*(1-l),p=2*l+3*(1-l),c=3*l+7*(1-l)<<d,y=(7*l+3*(1-l)<<h&e.geohashX)>>h,m=(c&e.geohashY)>>d;for(let e=u-1;e>=0;e--){const t=(a+o)/2,i=y&1<<e?1:0;a=(1-i)*a+i*t,o=(1-i)*t+i*o}for(let e=p-1;e>=0;e--){const t=(i+n)/2,a=m&1<<e?1:0;i=(1-a)*i+a*t,n=(1-a)*t+a*n}}return[a,i,o,n]}function T(e,t,i,n,a){a%2&&(a+=1);let o=0,s=0,r=-90,l=90,h=-180,d=180;for(let u=0;u<a/2;u++){for(let e=0;e<5;e++){const t=(h+d)/2,i=n>t?1:0;o|=i<<29-(e+5*u),h=(1-i)*h+i*t,d=(1-i)*t+i*d}for(let e=0;e<5;e++){const t=(r+l)/2,n=i>t?1:0;s|=n<<29-(e+5*u),r=(1-n)*r+n*t,l=(1-n)*t+n*l}}e[2*t]=o,e[2*t+1]=s}function w(e,t,i){let n="";const a=M(u,-90,90),o=M(p,-180,180);for(let s=0;s<i;s++){let i=0;s%2?(i|=x(a,e)<<4,i|=x(o,t)<<3,i|=x(a,e)<<2,i|=x(o,t)<<1,i|=x(a,e)|0):(i|=x(o,t)<<4,i|=x(a,e)<<3,i|=x(o,t)<<2,i|=x(a,e)<<1,i|=x(o,t)|0),n+=g(i)}return n}},36744:(e,t,i)=>{i.r(t),i.d(t,{default:()=>Ae});var n=i(35143),a=(i(35238),i(19276)),o=i(50076),s=i(76460),r=i(50346),l=i(46053),h=(i(81806),i(47249),i(85842)),d=i(26486),u=i(25515),p=i(98618),c=i(1484),y=i(91967),m=i(87663),f=i(34154),g=i(65215),v=i(9624),M=i(80963),_=i(20176),x=i(19902);class b{constructor(){this._featureLookup=new Map}static getInstance(){return b.instance||(b.instance=new b),b.instance}static resetInstance(){b.instance&&(b.instance=null)}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const i=this.readFromStoreById(e);i&&t.push(i)})),t}readFromStoreById(e){var t;return null!==(t=this._featureLookup.get(e))&&void 0!==t?t:null}writeToStore(e,t,i){const n=[];return e.forEach((e=>{if(null===e||void 0===e||!e.id)return;e.properties||(e.properties=[]);let a,o=null;if(i&&e.properties[i]&&(o=(0,p.Ux)(e.properties[i])),"originId"in e&&"destinationId"in e&&(e.properties.ESRI__ORIGIN_ID=e.originId,e.properties.ESRI__DESTINATION_ID=e.destinationId),e.properties[t]=e.id,e.id&&this._featureLookup.has(e.id)&&this._featureLookup.get(e.id).attributes){const n=this._featureLookup.get(e.id),s=JSON.parse(JSON.stringify(Object.assign(n.attributes,e.properties)));i&&e.properties[i]&&(s[i]=(0,x.rS)(e.properties[i])),a=new _.Om(o?JSON.parse(JSON.stringify(o)):null!==n&&void 0!==n&&n.geometry?JSON.parse(JSON.stringify(n.geometry)):null,s,null,e.properties[t])}else a=new _.Om(o?JSON.parse(JSON.stringify(o)):null,e.properties,null,e.properties[t]);this._featureLookup.set(e.id,a),n.push(a)})),n}}i(3825);var T,w=i(3576),L=i(35380);i(13312);!function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"}(T||(T={}));T.ELEMENTUID,T.TYPENAME;var k,C;!function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"}(k||(k={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(C||(C={}));var I,E,A,D;i(35121),i(31830);function N(e){if(!e.spatialReference.isWGS84)throw new o.A("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let t;return t=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],t}!function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"}(I||(I={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(E||(E={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(A||(A={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(D||(D={}));var R=i(97015),S=i(76797);const B="ESRI__ID",G="ESRI__ORIGIN_ID",F="ESRI__DESTINATION_ID",j="ESRI__LAYOUT_GEOMETRY",O="ESRI__AGGREGATION_COUNT",P=12;let q=class extends y.A{constructor(e){var t,i,n;super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const a=new Map;null!==(t=e.knowledgeGraph.dataModel.entityTypes)&&void 0!==t&&t.forEach((t=>{var i,n;t.name&&(a.set(t.name,"entity"),this._processingCacheUpdatesLookup.set(t.name,[]),e.inclusionModeDefinition&&!(null!==(i=e.inclusionModeDefinition)&&void 0!==i&&i.generateAllSublayers)||this.entityTypeNames.add(t.name),null===(n=t.properties)||void 0===n||n.forEach((e=>{var i;e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(t.name,{name:null!==(i=e.name)&&void 0!==i?i:"",geometryType:e.geometryType})})))})),null!==(i=e.knowledgeGraph.dataModel.relationshipTypes)&&void 0!==i&&i.forEach((t=>{var i,n;t.name&&(a.set(t.name,"relationship"),this._processingCacheUpdatesLookup.set(t.name,[]),e.inclusionModeDefinition&&!(null!==(i=e.inclusionModeDefinition)&&void 0!==i&&i.generateAllSublayers)||this.relationshipTypeNames.add(t.name),null===(n=t.properties)||void 0===n||n.forEach((e=>{var i;e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(t.name,{name:null!==(i=e.name)&&void 0!==i?i:"",geometryType:e.geometryType})})))})),null===(n=e.inclusionModeDefinition)||void 0===n||n.namedTypeDefinitions.forEach(((t,i)=>{var n;if("entity"===a.get(i))this.entityTypeNames.add(i);else{var o;if("relationship"!==a.get(i))return s.A.getLogger(this).warn("A named type, ".concat(i,", was in the inclusion list that wasn't in the data model and will be removed")),void(null===(o=e.inclusionModeDefinition)||void 0===o||o.namedTypeDefinitions.delete(i));this.relationshipTypeNames.add(i)}const r=new Map;null!==(n=t.members)&&void 0!==n&&n.forEach((e=>{(0,m.tE)(this.memberIdTypeLookup,e.id,(()=>new Set)).add(i);const t=this.getById(e.id);t&&r.set(e.id,t)})),this.sublayerCaches.set(i,r)}))}addToLayer(e){e.forEach((e=>{let{typeName:t,id:i}=e;if(!this.inclusionModeDefinition)throw new o.A("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const e=this.inclusionModeDefinition.namedTypeDefinitions.get(t);e.members||(e.members=new Map),e.members.set(i,{id:i}),(0,m.tE)(this.memberIdTypeLookup,i,(()=>new Set)).add(t)}}else{const e=new Map;e.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:e}),(0,m.tE)(this.memberIdTypeLookup,i,(()=>new Set)).add(t)}}))}getById(e){return b.getInstance().readFromStoreById(e)}async getData(e,t,i){var n;if(t.objectType.name&&null!==(n=this.inclusionModeDefinition)&&void 0!==n&&n.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let a;if(a=e||new R.A({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){var o,s,r;const e=t.parentCompositeLayer,i=this._processingCacheUpdatesLookup.get(null!==(o=t.objectType.name)&&void 0!==o?o:""),n=a.outFields,l=a.geometry;let h="",u="";l&&l.extent&&(h=(0,d.Qj)(l.extent.ymin,l.extent.xmin,P),u=(0,d.Qj)(l.extent.ymax,l.extent.xmax,P)),n&&1===n.length&&n[0]===B&&"1=1"===a.where||await Promise.all(null!==i&&void 0!==i?i:[]);const p=this.sublayerCaches.has(null!==(s=t.objectType.name)&&void 0!==s?s:"")?Array.from(null===(r=this.sublayerCaches.get(t.objectType.name))||void 0===r?void 0:r.values()):[],c=[];return p.forEach((i=>{if(this.relationshipTypeNames.has(t.objectType.name)?i.geometry=e.relationshipLinkChartDiagramLookup.get(i.attributes[t.objectIdField]):i.geometry=e.entityLinkChartDiagramLookup.get(i.attributes[t.objectIdField]),i.attributes[j]=i.geometry,h&&u){const n=e.linkChartGeohashLookup.get(i.attributes[t.objectIdField]);n?n>=h&&n<=u&&c.push(i):c.push(i)}else c.push(i)})),c}return this.retrieveDataFromService(a,t,i)}async getConnectedRecordIds(e,t){const i=[];let n="";const a=[],o=new Map;if(e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const i of this.memberIdTypeLookup.get(e)){var t;if(!this.entityTypeNames.has(i))return;o.has(i)?null===(t=o.get(i))||void 0===t||t.push(e):o.set(i,[e])}})),t&&0!==(null===t||void 0===t?void 0:t.length)){for(const e of t)n=n+e+"|";n=n.slice(0,-1)}return o.forEach(((e,o)=>{let r;r=t&&0!==(null===t||void 0===t?void 0:t.length)?"MATCH (n:".concat(o,")-[r:").concat(n,"]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]"):"MATCH (n:".concat(o,")-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]");const l=new Promise((t=>{(async()=>{const t=(await(0,w.executeQueryStreaming)(this.knowledgeGraph,new L.A({openCypherQuery:r,bindParameters:{ids:e}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:n}=await t.read();if(e)break;for(let t=0;t<n.length;t++){const e=n[t];i.push({id:e[0],typeName:e[1]}),i.push({id:e[2],typeName:e[3]})}}}catch(n){if("AbortError"!==n.name)throw n;s.A.getLogger(this).info("Request aborted as expected")}})().then((()=>{t()}))}));a.push(l)})),this.refreshCacheContent(),await Promise.all(a),i}async refreshCacheContent(e,t,i){var n,a,s,r,l;let h=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const d=b.getInstance(),u=[],p=new Map,c=new Map;null!==(n=this.knowledgeGraph.dataModel.entityTypes)&&void 0!==n&&n.forEach((e=>{e.name&&c.set(e.name,e)})),null!==(a=this.knowledgeGraph.dataModel.relationshipTypes)&&void 0!==a&&a.forEach((e=>{e.name&&c.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const i of this.memberIdTypeLookup.get(e)){var t;p.has(i)?null===(t=p.get(i))||void 0===t||t.push(e):p.set(i,[e])}})):null===(s=this.inclusionModeDefinition)||void 0===s||null===(s=s.namedTypeDefinitions)||void 0===s||s.forEach(((e,t)=>{e.useAllData?p.set(t,null):e.members&&e.members.forEach((e=>{var i;p.has(t)&&null!==p.get(t)?null===(i=p.get(t))||void 0===i||i.push(e.id):p.set(t,[e.id])}))})):(null!==(r=this.knowledgeGraph.dataModel.entityTypes)&&void 0!==r&&r.forEach((e=>{e.name&&p.set(e.name,null)})),null===(l=this.knowledgeGraph.dataModel.entityTypes)||void 0===l||l.forEach((e=>{e.name&&p.set(e.name,null)})));for(const[f,g]of p){var y;const e=new Promise((e=>{(async()=>{var e;const n=new Set,a=[];let s,r="",l=!1;if(t||null!==(e=c.get(f))&&void 0!==e&&null!==(e=e.properties)&&void 0!==e&&e.forEach((e=>{e.name&&n.add(e.name)})),i&&this.geographicLookup.has(f)){var u;const e=null===(u=this.geographicLookup.get(f))||void 0===u?void 0:u.name;e&&n.add(e)}if(this.entityTypeNames.has(f))r="MATCH (n:".concat(f,") ").concat(g?"WHERE id(n) IN $ids ":"","return ID(n)"),n.forEach((e=>{r+=", n.".concat(e),a.push(e)}));else{if(!this.relationshipTypeNames.has(f))throw new o.A("knowledge-graph:layer-data-manager","The graph type of ".concat(f," could not be determined. Was this type set in the KG data model and inclusion definition?"));l=!0,r="MATCH ()-[n:".concat(f,"]->() ").concat(g?"WHERE id(n) IN $ids ":"","return ID(n), id(startNode(n)), id(endNode(n))"),n.forEach((e=>{r+=", n.".concat(e),a.push(e)}))}s=new L.A(g?{openCypherQuery:r,bindParameters:{ids:g}}:{openCypherQuery:r});const p=(await(0,w.executeQueryStreaming)(this.knowledgeGraph,s)).resultRowsStream.getReader();for(;;){var y,v,M,_;const{done:e,value:t}=await p.read();if(e)break;const i=[];for(let s=0;s<t.length;s++){const e=t[s];let n=0,o=0;const r={properties:{}};for(r.id=e[n],n++,o++,l&&(r.originId=e[n],n++,o++,r.destinationId=e[n],n++,o++,(0,m.tE)(this.nodeConnectionsLookup,r.originId,(()=>new Set)).add(r.id),(0,m.tE)(this.nodeConnectionsLookup,r.destinationId,(()=>new Set)).add(r.id),(0,m.tE)(this.relationshipConnectionsLookup,r.id,(()=>[r.originId,r.destinationId])));n<e.length;n++)r.properties[a[n-o]]=e[n];i.push(r)}const n=d.writeToStore(i,B,null===(y=this.geographicLookup.get(f))||void 0===y?void 0:y.name);this.sublayerCaches.has(f)||this.sublayerCaches.set(f,new Map),h&&!(null!==(v=this.inclusionModeDefinition)&&void 0!==v&&v.namedTypeDefinitions.has(f))&&null!==(M=this.inclusionModeDefinition)&&void 0!==M&&M.namedTypeDefinitions.set(f,{useAllData:!1,members:new Map}),h&&(null===(_=this.inclusionModeDefinition)||void 0===_||!_.namedTypeDefinitions.get(f).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(f).members=new Map);const o=this.sublayerCaches.get(f);n.forEach((e=>{var t,i;null!==o&&void 0!==o&&o.set(e.attributes[B],e),h&&(null===(t=this.inclusionModeDefinition)||void 0===t||!t.namedTypeDefinitions.get(f).members.has(e.attributes[B]))&&(null!==(i=this.inclusionModeDefinition)&&void 0!==i&&i.namedTypeDefinitions.get(f).members.set(e.attributes[B],{id:e.attributes[B]}),(0,m.tE)(this.memberIdTypeLookup,e.attributes[B],(()=>new Set)).add(f))}))}})().then((()=>{e(null)}))}));u.push(e),null===(y=this._processingCacheUpdatesLookup.get(f))||void 0===y||y.push(e)}await Promise.all(u)}removeFromLayer(e){const t=new Set,i=new Set(e.map((e=>e.id)));for(const s of e){var n,a,o;t.add(s.typeName),1===(null===(n=this.memberIdTypeLookup.get(s.id))||void 0===n?void 0:n.size)?this.memberIdTypeLookup.delete(s.id):null===(a=this.memberIdTypeLookup.get(s.id))||void 0===a||a.delete(s.typeName),null===(o=this.inclusionModeDefinition)||void 0===o||o.namedTypeDefinitions.forEach(((e,t)=>{var i;t===s.typeName&&(null===(i=e.members)||void 0===i?void 0:i.has(s.id))&&e.members.delete(s.id)}))}t.forEach((e=>{var t;null===(t=this.sublayerCaches.get(e))||void 0===t||t.forEach(((t,n)=>{var a;i.has(n)&&(null===(a=this.sublayerCaches.get(e))||void 0===a||a.delete(n))}))}))}async retrieveDataFromService(e,t,i){var n,a,s;const r=b.getInstance(),l=new Set,h=[];let d,u="",p=[];const c="relationship"===t.graphType,y=null===(n=this.inclusionModeDefinition)||void 0===n||null===(n=n.namedTypeDefinitions)||void 0===n||null===(n=n.get(t.objectType.name))||void 0===n?void 0:n.useAllData,m=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let _=!y&&m?Array.from(m).sort():null;if(null!==(a=this.inclusionModeDefinition)&&void 0!==a&&null!==(a=a.namedTypeDefinitions)&&void 0!==a&&null!==(a=a.get(t.objectType.name))&&void 0!==a&&a.useAllData)(null===(s=this.inclusionModeDefinition)||void 0===s||null===(s=s.namedTypeDefinitions)||void 0===s||null===(s=s.get(t.objectType.name))||void 0===s?void 0:s.useAllData)&&null!=e.objectIds&&(_=e.objectIds);else if(null!=e.objectIds&&_&&_.length>0){const t=e.objectIds;e.objectIds=_.filter((e=>t.includes(e)))}else if(null!=e.objectIds)_=e.objectIds;else{var x,T,k;if(null!==(x=this.inclusionModeDefinition)&&void 0!==x&&x.namedTypeDefinitions.has(t.objectType.name)&&(null===(T=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))||void 0===T||!T.members||(null===(k=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))||void 0===k||null===(k=k.members)||void 0===k?void 0:k.size)<1))return e.objectIds=[],[];e.objectIds=_}if(null!=e.outFields){const i=e.outFields;i.includes("*")?t.fields.forEach((e=>{l.add(e.name)})):i.forEach((e=>{e!==B&&e!==t.geometryFieldName&&l.add(e)}))}if(null!=e.geometry){var C,I,E;const i=e.geometry;let n;const a=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,s=null===a||void 0===a?void 0:a.spatialReference,r=null===a||void 0===a||null===(C=a.serviceCapabilities)||void 0===C?void 0:C.geometryCapabilities;let p=null===r||void 0===r?void 0:r.geometryMaxBoundingRectangleSizeX,y=null===r||void 0===r?void 0:r.geometryMaxBoundingRectangleSizeY;if(null===i||void 0===i||null===(I=i.extent)||void 0===I||!I.spatialReference||null!==(E=i.spatialReference)&&void 0!==E&&E.isWGS84?n=i.extent:(await(0,v.initializeProjection)(i.extent.spatialReference,M.KK),n=(0,v.project)(i.extent,M.KK)),p&&y&&s){if(4326!==s.wkid){const e=new S.A({spatialReference:s,xmax:p,ymax:y}),t=(0,v.project)(e,M.KK);p=t.xmax,y=t.ymax}if(n.xmax-n.xmin>p)throw new o.A("knowledge-graph:layer-data-manager","Extent x bounds should be within ".concat(p,"\xb0 latitude, limit exceeded"));if(n.ymax-n.ymin>y)throw new o.A("knowledge-graph:layer-data-manager","Extent y bounds should be within ".concat(y,"\xb0 longitude, limit exceeded"))}if(null!=e.where&&"1=1"!==e.where){const i=await(0,f.G)(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{i.fieldNames.includes(e.name)&&l.add(e.name)}))}u=c?"Match ()-[n:".concat(t.objectType.name,"]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.").concat(t.geometryFieldName,") return ID(n), id(startNode(r)), id(endNode(r))"):"Match (n:".concat(t.objectType.name,") WHERE esri.graph.ST_Intersects($param_filter_geom, n.").concat(t.geometryFieldName,") return ID(n)"),t.geometryFieldName&&l.add(t.geometryFieldName),l.forEach((e=>{u+=", n.".concat(e),h.push(e)})),d=new L.A({openCypherQuery:u,bindParameters:{param_filter_geom:new g.A({rings:N(n)})}})}else{let i="";if(null!=e.where&&"1=1"!==e.where){const n=await(0,f.G)(e.where,t.fieldsIndex);t.fields.forEach((e=>{n.fieldNames.includes(e.name)&&l.add(e.name)}));const a=new Set(["column-reference","string","number","binary-expression"]),o=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let s=!1;const r=e=>{if("column-reference"===e.type)return"n.".concat(e.column);if("string"===e.type)return"'".concat(e.value,"'");if("number"===e.type)return"".concat(e.value);if("binary-expression"===e.type&&a.has(e.left.type)&&a.has(e.right.type)&&o.has(e.operator))return"".concat(r(e.left)," ").concat(e.operator," ").concat(r(e.right));if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+="lower(n.".concat(e.left.args.value[0].column,")");else{if("column-reference"!==e.left.type)return s=!0,"";t+="lower(n.".concat(e.left.column,")")}if(t+=" CONTAINS (","string"!==e.right.type)return s=!0,"";{let i=e.right.value;"%"===i.charAt(0)&&(i=i.slice(1)),"%"===i.charAt(i.length-1)&&(i=i.slice(0,-1)),t+="'".concat(i.toLowerCase(),"')")}return t}return s=!0,""};i=r(n.parseTree),s&&(i="")}let n="";n=c?"Match ()-[n:".concat(t.objectType.name,"]->()"):"Match (n:".concat(t.objectType.name,")");let a=!1;_&&(a=!0,n+=" WHERE ID(n) IN $ids"),i&&(n+=a?" AND":" WHERE",n+=" ".concat(i)),n+=" return ID(n)",c&&(n+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&l.add(t.geometryFieldName),l.forEach((e=>{n+=", n.".concat(e),h.push(e)})),d=new L.A(_?{openCypherQuery:n,bindParameters:{ids:_}}:{openCypherQuery:n})}const A=(await(0,w.executeQueryStreaming)(t.parentCompositeLayer.dataManager.knowledgeGraph,d,i)).resultRowsStream.getReader();for(;;){var D;const{done:e,value:i}=await A.read();if(e)break;const n=[];for(let t=0;t<i.length;t++){const e=i[t];let a=0,o=0;const s={properties:{}};for(s.id=e[a],a++,o++,c&&(s.originId=e[a],a++,o++,s.destinationId=e[a],a++,o++);a<e.length;a++)s.properties[h[a-o]]=e[a];n.push(s)}p=p.concat(r.writeToStore(n,B,null===(D=t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name))||void 0===D?void 0:D.name))}return p}};(0,n._)([(0,l.MZ)()],q.prototype,"knowledgeGraph",void 0),(0,n._)([(0,l.MZ)()],q.prototype,"inclusionModeDefinition",void 0),(0,n._)([(0,l.MZ)()],q.prototype,"entityTypeNames",void 0),(0,n._)([(0,l.MZ)()],q.prototype,"relationshipTypeNames",void 0),(0,n._)([(0,l.MZ)()],q.prototype,"geographicLookup",void 0),(0,n._)([(0,l.MZ)()],q.prototype,"sublayerCaches",void 0),(0,n._)([(0,l.MZ)()],q.prototype,"nodeConnectionsLookup",void 0),(0,n._)([(0,l.MZ)()],q.prototype,"relationshipConnectionsLookup",void 0),(0,n._)([(0,l.MZ)()],q.prototype,"memberIdTypeLookup",void 0),q=(0,n._)([(0,h.$)("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],q);var Z=i(89379),Y=i(16868),Q=(i(63844),i(14873),i(47662),i(72690),i(86946),i(71832),i(5766),i(35039),i(86616)),U=i(31382),X=(i(16783),i(72547)),H=i(26151),J=i(40296);const z=(0,i(76350).p)(),$=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return(0,n._)([(0,l.MZ)(z.fields)],t.prototype,"fields",void 0),(0,n._)([(0,l.MZ)(z.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=(0,n._)([(0,h.$)("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};var W=i(65624),V=i(71448),K=i(21617),ee=i(5682),te=i(55053),ie=i(44135),ne=i(53430),ae=i(77725),oe=i(30973),se=i(59989),re=i(23701),le=i(31608);let he=class extends((0,V.J)($((0,W.d)((0,ee.j)((0,K.J)(u.A)))))){constructor(e){var t,i,n,a,o;if(super(e),t=this,this.capabilities=(0,J.f)(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=B,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new se.A(e.port1,{channel:e,client:{queryFeatures:function(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=R.A.fromJSON(e);return t.queryFeaturesJSON(n,i)}}}),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=j;else if(null!==(i=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name))&&void 0!==i&&i.geometryType&&"esriGeometryNull"!==(null===(n=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name))||void 0===n?void 0:n.geometryType)){var s,r,l,h;const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=null!==(s=null===t||void 0===t?void 0:t.name)&&void 0!==s?s:null,this.geometryType=null!==t&&void 0!==t&&t.geometryType?le.g.fromJSON(t.geometryType):null;const i=null===t||void 0===t?void 0:t.name,n=i?null===(r=e.objectType.properties)||void 0===r?void 0:r[i]:null;n?(this.hasM=null!==(l=n.hasM)&&void 0!==l&&l,this.hasZ=null!==(h=n.hasZ)&&void 0!==h&&h):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;null!==(a=e.objectType.properties)&&void 0!==a&&a.forEach((e=>{let t=e.fieldType;"esriFieldTypeOID"===t&&(t="esriFieldTypeInteger"),this.fields.push(ie.A.fromJSON({name:e.name,type:t,alias:e.alias,defaultValue:null,editable:e.editable,nullable:e.nullable}))})),this.fields.push(ie.A.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this.fields.push(ie.A.fromJSON({name:O,type:"esriFieldTypeInteger",alias:O,editable:!1})),this._set("fields",[...this.fields]),null!==(o=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel)&&void 0!==o&&o.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=(0,Q.r)((0,J.F0)(le.g.toJSON("polyline")).renderer):this.renderer=(0,Q.r)((0,J.F0)(le.g.toJSON("point")).renderer):this.renderer=(0,Q.r)((0,J.F0)(le.g.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){(0,ne.yp)(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return(0,oe.tn)(this,e)}createQuery(){return new R.A({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e),a=ae.A.fromJSON(await n.executeQuery(i.toJSON(),null===t||void 0===t?void 0:t.signal));return a.features.forEach((e=>{e.sourceLayer=this})),a}async queryFeaturesJSON(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e);return await n.executeQuery(i.toJSON(),null===t||void 0===t?void 0:t.signal)}async queryFeatureCount(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e);return n.executeQueryForCount(i.toJSON(),null===t||void 0===t?void 0:t.signal)}async queryExtent(){var e,t,i,n;let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1?arguments[1]:void 0;const s=(0,Z.A)((0,Z.A)({},a),{},{returnGeometry:!0}),{resolvedQuery:r,queryEngine:l}=await this._setupQueryObjects(s),h=await l.executeQueryForExtent(r.toJSON(),null===o||void 0===o?void 0:o.signal);let d;return d=null!=(null===(e=h.extent)||void 0===e?void 0:e.xmin)&&null!=(null===(t=h.extent)||void 0===t?void 0:t.xmax)&&null!=(null===(i=h.extent)||void 0===i?void 0:i.ymin)&&null!=(null===(n=h.extent)||void 0===n?void 0:n.ymax)?new S.A(h.extent):new S.A,{count:h.count,extent:d}}async queryObjectIds(e,t){const i=R.A.from(e);let n;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(i,this,t);n=this.loadQueryEngine(e)}return n.executeQueryForIds(i.toJSON(),null===t||void 0===t?void 0:t.signal)}loadQueryEngine(e){const t=new X.A({geometryType:le.g.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),i=new H.d({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:le.g.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return i.featureStore.addMany(e),i}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new R.A({where:"1=1",outFields:[B]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){var i;const n=R.A.from(e),a=n.geometry;let o;if(a&&!(null!==(i=a.spatialReference)&&void 0!==i&&i.isWGS84)&&(await(0,v.initializeProjection)(a.spatialReference,M.KK),n.geometry=(0,v.project)(a instanceof g.A||a instanceof re.A?a:a.extent,M.KK)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)o=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(n,this,t);o=this.loadQueryEngine(e)}return{resolvedQuery:n,queryEngine:o}}};(0,n._)([(0,l.MZ)()],he.prototype,"capabilities",void 0),(0,n._)([(0,l.MZ)({readOnly:!0})],he.prototype,"defaultPopupTemplate",null),(0,n._)([(0,l.MZ)()],he.prototype,"definitionExpression",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"displayField",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"elevationInfo",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"geometryType",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"geometryFieldName",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"graphType",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"hasM",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"hasZ",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"labelsVisible",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"labelingInfo",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"objectIdField",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"objectType",void 0),(0,n._)([(0,l.MZ)()],he.prototype,"parentCompositeLayer",void 0),(0,n._)([(0,l.MZ)(te.M6)],he.prototype,"popupEnabled",void 0),(0,n._)([(0,l.MZ)({type:Y.A,json:{name:"popupInfo",write:!0}})],he.prototype,"popupTemplate",void 0),(0,n._)([(0,l.MZ)({types:U.H,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],he.prototype,"renderer",null),(0,n._)([(0,l.MZ)()],he.prototype,"source",void 0),(0,n._)([(0,l.MZ)({json:{read:!1}})],he.prototype,"type",void 0),he=(0,n._)([(0,h.$)("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],he);const de=he;var ue=i(28899);let pe,ce=null;function ye(){return pe||(pe=i.e(3884).then(i.bind(i,83884)).then((e=>e.l)).then((e=>{let{default:t}=e;return t({locateFile:e=>(0,ue.s)("esri/libs/linkchartlayout/".concat(e))})})).then((e=>{!function(e){ce=e}(e)})),pe)}var me,fe;function ge(e,t,i,n,a,o){const s=i.length,r=a.length,l=Float64Array.BYTES_PER_ELEMENT,h=Uint32Array.BYTES_PER_ELEMENT,d=Uint8Array.BYTES_PER_ELEMENT,u=15+s*(d+2*l)+r*(2*h),p=ce._malloc(u);try{const d=p+16-p%16,u=d+s*l,c=u+s*l,y=c+r*h,m=y+r*h,f=()=>[ce.HEAPF64.subarray(d>>3,(d>>3)+s),ce.HEAPF64.subarray(u>>3,(u>>3)+s),ce.HEAPU32.subarray(c>>2,(c>>2)+r),ce.HEAPU32.subarray(y>>2,(y>>2)+r),ce.HEAPU8.subarray(m,m+s)],[g,v,M,_,x]=f();g.set(i),v.set(n),M.set(a),_.set(o),x.set(t);let b=e(s,m,d,u,r,c,y),T=null;if(b){const e=ce.getLayoutLinksTypes(),t=ce.getLayoutLinksVerticesEndIndices(),i=ce.getLayoutLinksVertices(),n=ce.countLayoutLinksVertices();!r||e&&t?n&&!i?b=!1:T={types:new Uint8Array(ce.HEAPU8.subarray(e,e+r)),vertexEndIndex:new Uint32Array(ce.HEAPU32.subarray(t>>2,(t>>2)+r)),vertices:new Float64Array(ce.HEAPF64.subarray(i>>3,(i>>3)+2*n))}:b=!1}const[w,L,k,C,I]=f();return i.set(w),n.set(L),a.set(k),o.set(C),t.set(I),{success:b,links:T}}finally{ce._free(p),ce.cleanupLayout()}}!function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"}(me||(me={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(fe||(fe={}));var ve,Me,_e,xe,be,Te,we,Le;!function(e){e.getMinIdealEdgeLength=function(){return ce.getMinIdealEdgeLength()},e.apply=function(e,t,i,n,a){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,r=arguments.length>7&&void 0!==arguments[7]?arguments[7]:-1;return ge(((e,t,i,n,a,l,h)=>ce.applyForceDirectedLayout(e,t,i,n,a,l,h,o,s,r)),e,t,i,n,a)}}(ve||(ve={})),function(e){e.apply=function(e,t,i,n,a){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,r=arguments.length>7&&void 0!==arguments[7]?arguments[7]:-1;return ge(((e,t,i,n,a,l,h)=>ce.applyCommunityLayout(e,t,i,n,a,l,h,o,s,r)),e,t,i,n,a)}}(Me||(Me={})),function(e){e.apply=function(e,t,i,n,a){return ge(ce.applySimpleLayout,e,t,i,n,a)}}(_e||(_e={})),function(e){e.apply=function(e,t,i,n,a){return ge(ce.applyHierarchicalLayout,e,t,i,n,a)}}(xe||(xe={})),function(e){e.apply=function(e,t,i,n,a){return ge(ce.applyRadialTreeLayout,e,t,i,n,a)}}(be||(be={})),function(e){e.apply=function(e,t,i,n,a){return ge(ce.applySmartTreeLayout,e,t,i,n,a)}}(Te||(Te={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(we||(we={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(Le||(Le={}));var ke=i(46801),Ce=i(84252),Ie=i(13904);let Ee=class extends((0,W.d)((0,ee.j)(u.A))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new a.A,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new S.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new a.A,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new o.A("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){var t,i,n,a,r,l,h,d,u,p;if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2]}const c=new Set;let y=[],m=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new o.A("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");null!==(t=e.knowledgeGraph.dataModel.entityTypes)&&void 0!==t&&t.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),null!==(i=e.knowledgeGraph.dataModel.relationshipTypes)&&void 0!==i&&i.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),null!==(n=e.inclusionModeDefinition)&&void 0!==n&&n.generateAllSublayers?(y=null!==(a=e.knowledgeGraph.dataModel.entityTypes)&&void 0!==a?a:[],m=null!==(r=e.knowledgeGraph.dataModel.relationshipTypes)&&void 0!==r?r:[]):null!==(l=e.inclusionModeDefinition)&&void 0!==l&&l.namedTypeDefinitions&&(null===(h=e.inclusionModeDefinition)||void 0===h?void 0:h.namedTypeDefinitions.size)>0?null===(d=e.inclusionModeDefinition)||void 0===d||d.namedTypeDefinitions.forEach(((t,i)=>{var n,a;if(!this._graphTypeLookup.get(i))return s.A.getLogger(this).warn("A named type, ".concat(i,", was in the inclusion list that wasn't in the data model and will be removed")),void(null===(n=e.inclusionModeDefinition)||void 0===n||n.namedTypeDefinitions.delete(i));this._graphTypeLookup.get(i)instanceof Ce.A||"strictOrigin"in this._graphTypeLookup.get(i)?c.has(i)||(c.add(i),m.push(this._graphTypeLookup.get(i))):this._graphTypeLookup.get(i)instanceof ke.A||"properties"in this._graphTypeLookup.get(i)?c.has(i)||(c.add(i),y.push(this._graphTypeLookup.get(i))):(s.A.getLogger(this).warn("A named type, ".concat(i,", was in the inclusion list that wasn't properly modeled and will be removed")),null===(a=e.inclusionModeDefinition)||void 0===a||a.namedTypeDefinitions.delete(i))})):(y=null!==(u=e.knowledgeGraph.dataModel.entityTypes)&&void 0!==u?u:[],m=null!==(p=e.knowledgeGraph.dataModel.relationshipTypes)&&void 0!==p?p:[]);const f=new q({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=y,this.memberRelationshipTypes=m,this.dataManager=f}load(e){return this.addResolvingPromise(new Promise((t=>{(0,w.fetchKnowledgeGraph)(this.url).then((i=>{var n,a,o,s;if(this._initializeLayerProperties({knowledgeGraph:i,inclusionModeDefinition:this._originalInclusionList}),null!==(n=this.dataManager.inclusionModeDefinition)&&void 0!==n&&null!==(n=n.namedTypeDefinitions)&&void 0!==n&&n.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},null!==(a=this.dataManager.knowledgeGraph.dataModel.entityTypes)&&void 0!==a&&a.forEach((e=>{var t;e.name&&(null===(t=this.dataManager.inclusionModeDefinition)||void 0===t||t.namedTypeDefinitions.set(e.name,{useAllData:!0}))})),null!==(o=this.dataManager.knowledgeGraph.dataModel.relationshipTypes)&&void 0!==o&&o.forEach((e=>{var t;e.name&&(null===(t=this.dataManager.inclusionModeDefinition)||void 0===t||t.namedTypeDefinitions.set(e.name,{useAllData:!0}))}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),null===(s=this.dataManager.inclusionModeDefinition)||void 0===s||s.namedTypeDefinitions.forEach((e=>{var t;e.useAllData=!1,null!==(t=e.members)&&void 0!==t&&t.forEach((e=>{let t;t=e.linkChartLocation instanceof c.A?e.linkChartLocation:e.linkChartLocation?(0,p.Ux)(e.linkChartLocation):null,t&&2===t.coords.length&&0===t.lengths.length?(this.linkChartGeohashLookup.set(e.id,(0,d.Qj)(t.coords[1],t.coords[0],P)),this.entityLinkChartDiagramLookup.set(e.id,t)):(this.linkChartGeohashLookup.set(e.id,""),this.relationshipLinkChartDiagramLookup.set(e.id,t))})),this.addResolvingPromise(this._initializeDiagram().then((async()=>{this.layers.forEach((async e=>{await e.refreshCachedQueryEngine()})),this.tables.forEach((async e=>{await e.refreshCachedQueryEngine()}))})))}));else{var l;const t="GEOGRAPHIC"===(null===(l=this.defaultLinkChartConfig)||void 0===l?void 0:l.layoutMode);this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then((async()=>{(0,r.Te)(e);const t=[],i=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1}))),await this._initializeDiagram(),this.layers.forEach((e=>{i.push(e.refreshCachedQueryEngine()),t.push(new Promise((t=>{e.on("layerview-create",(()=>{t(null)}))})))})),this.tables.forEach((e=>{i.push(e.refreshCachedQueryEngine())})),await Promise.all(i)})))}t(null)}))}))),Promise.resolve(this)}async addRecords(e,t){let i=[];(null===t||void 0===t?void 0:t.cascadeAddRelationshipEndNodes)&&this.dataManager.knowledgeGraph.dataModel&&(i=await async function(e,t){var i;const n=[],a=new Map,o=[];if(null!==(i=t.dataModel)&&void 0!==i&&i.relationshipTypes)for(const r of t.dataModel.relationshipTypes)r.name&&a.set(r.name,[]);for(const r of e){var s;a.has(r.typeName)&&(null===(s=a.get(r.typeName))||void 0===s||s.push(r.id))}for(const[r,l]of a){if(l.length<1)continue;const e=new L.A({openCypherQuery:"MATCH (n)-[r:".concat(r,"]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]"),bindParameters:{ids:l}});o.push((0,w.executeQueryStreaming)(t,e).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:i}=await t.read();if(e)break;for(const t of i)n.push({id:t[0],typeName:t[1]}),n.push({id:t[2],typeName:t[3]})}})))}return await Promise.all(o),n}(e,this.dataManager.knowledgeGraph));const n=e.concat(i).filter((e=>{var t;return!(null!==(t=this.sublayerIdsCache.get(e.typeName))&&void 0!==t&&t.has(e.id))}));await this._handleNewRecords(n)}async removeRecords(e){let{cascadeRemoveRelationships:t=!0,recalculateLayout:i=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{cascadeRemoveRelationships:!0,recalculateLayout:!1},n=[];for(const l of e){var a,o;!1===(null===(a=this.dataManager.inclusionModeDefinition)||void 0===a||null===(a=a.namedTypeDefinitions)||void 0===a||null===(a=a.get(l.typeName))||void 0===a?void 0:a.useAllData)&&(null===(o=this.dataManager.inclusionModeDefinition)||void 0===o||null===(o=o.namedTypeDefinitions)||void 0===o||null===(o=o.get(l.typeName))||void 0===o||null===(o=o.members)||void 0===o?void 0:o.has(l.id))&&n.push(l)}if(t){const e=new Set,t=[];for(const i of n)if(this.dataManager.nodeConnectionsLookup.has(i.id))for(const t of this.dataManager.nodeConnectionsLookup.get(i.id))e.add(t);for(const i of e)if(this.dataManager.memberIdTypeLookup.has(i))for(const e of this.dataManager.memberIdTypeLookup.get(i))this.dataManager.relationshipTypeNames.has(e)&&t.push({id:i,typeName:e});n=n.concat(t)}this.dataManager.removeFromLayer(n);for(const l of n){var s;null!==(s=this.sublayerIdsCache.get(l.typeName))&&void 0!==s&&s.delete(l.id),this.dataManager.relationshipTypeNames.has(l.typeName)?this.relationshipLinkChartDiagramLookup.delete(l.id):this.entityLinkChartDiagramLookup.delete(l.id)}i&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{});const r=[];return this.layers.forEach((e=>{r.push(e.refreshCachedQueryEngine())})),await Promise.all(r),this._refreshNamedTypes(),n}async expand(e,t){const i=await this.dataManager.getConnectedRecordIds(e,t),n=i.filter((e=>{var t;return!(null!==(t=this.sublayerIdsCache.get(e.typeName))&&void 0!==t&&t.has(e.id))}));return await this._handleNewRecords(i),{records:n}}loadLayerAssumingLocalCache(){var e,t;this.memberRelationshipTypes.forEach((e=>{const t=new de({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberEntityTypes.forEach((e=>{const t=new de({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),(null===(e=this.dataManager.inclusionModeDefinition)||void 0===e?void 0:e.namedTypeDefinitions)&&(null===(t=this.dataManager.inclusionModeDefinition)||void 0===t||t.namedTypeDefinitions.forEach(((e,t)=>{var i;const n=((e,t,i)=>(e.has(t)||e.set(t,i()),e.get(t)))(this.sublayerIdsCache,t,(()=>new Set));null===(i=e.members)||void 0===i||i.forEach((e=>{if(n.add(e.id),e.linkChartLocation)if(e.linkChartLocation instanceof c.A)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,(0,d.Qj)(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],P)):this.linkChartGeohashLookup.set(e.id,"");else{const i=(0,p.Ux)(e.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation?i:null):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation?i:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,(0,d.Qj)(e.linkChartLocation.x,e.linkChartLocation.y,P)):this.linkChartGeohashLookup.set(e.id,"")}}))})))}async calculateLinkChartLayout(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"RADIAL_TREE",t=arguments.length>1?arguments[1]:void 0;const i=[],n=[],a=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{i.push({typeName:t,feature:e})})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{n.push({typeName:t,feature:e})}))})),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const r=new Map,l=new Map,h=new Map,u=new Map,c=new Uint8Array(i.length),y=new Float64Array(i.length),m=new Float64Array(i.length),f=new Uint32Array(n.length),g=new Uint32Array(n.length),v=[],M=new S.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let _,x="FORCE_DIRECTED",b=0,T=0;switch(x="GEOGRAPHIC"===e?"FORCE_DIRECTED":e,x){case"FORCE_DIRECTED":_=ve.apply;break;case"COMMUNITY":_=Me.apply;break;case"HIERARCHICAL":_=xe.apply;break;case"RADIAL_TREE":_=be.apply;break;case"SMART_TREE":_=Te.apply;break;default:_=_e.apply}i.forEach((i=>{var n,a,o,s,r,l;let{typeName:h,feature:d}=i;if(null!==t&&void 0!==t&&null!==(n=t.lockedNodeLocations)&&void 0!==n&&n.has(d.attributes[B])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(h)?c[b]=me.IsGeographic:c[b]=me.None;const i=t.lockedNodeLocations.get(d.attributes[B]);y[b]=i.x,m[b]=i.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(h)){var p;c[b]=me.IsGeographic;let e=null;const t=d.attributes[this.dataManager.geographicLookup.get(h).name];switch(null===(p=this.dataManager.geographicLookup.get(h))||void 0===p?void 0:p.geometryType){case"esriGeometryPoint":y[b]=null===t||void 0===t?void 0:t.x,m[b]=null===t||void 0===t?void 0:t.y;break;case"esriGeometryPolygon":e=null===t||void 0===t?void 0:t.centroid,null!=(null===(a=e)||void 0===a?void 0:a.x)&&null!=(null===(o=e)||void 0===o?void 0:o.y)?(y[b]=e.x,m[b]=e.y):c[b]=me.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=null===t||void 0===t||null===(s=t.extent)||void 0===s?void 0:s.center,null!=(null===(r=e)||void 0===r?void 0:r.x)&&null!=(null===(l=e)||void 0===l?void 0:l.y)?(y[b]=e.x,m[b]=e.y):c[b]=me.IsMovable;break;default:c[b]=me.IsMovable}(null==y[b]||null==m[b]||Number.isNaN(y[b])||Number.isNaN(m[b]))&&(c[b]=me.IsMovable,y[b]=0,m[b]=0)}else c[b]=me.IsMovable,y[b]=0,m[b]=0;u.set(d.attributes[B],b),v[b]={feature:d,typeName:h},b++}));let w=!1;const L=new Map;n.forEach((e=>{const t=e.feature.attributes[G],i=e.feature.attributes[F],n=u.get(t),o=u.get(i);if(void 0!==n&&void 0!==o){const s=t+"-"+i,r=L.get(s);(null===r||void 0===r?void 0:r.has(e.typeName))||(f[T]=n,g[T]=o,void 0===r?L.set(s,new Map([[e.typeName,T]])):r.set(e.typeName,T),T++),a.push(e)}else w=!0,this.relationshipLinkChartDiagramLookup.set(t,null),this.linkChartGeohashLookup.set(t,null)})),w&&s.A.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await ye();const{success:k,links:C}=_(c,y,m,f.subarray(0,T),g.subarray(0,T));if(!k)throw new o.A("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let o=0;o<v.length;o++){if(m[o]>84.9999?m[o]=84.9999:m[o]<-84.9999&&(m[o]=-84.9999),y[o]>179.9999?y[o]=179.9999:y[o]<-179.9999&&(y[o]=-179.9999),v[o].feature.attributes[j]=new Ie.A(y[o],m[o]),r.has(v[o].typeName)){const e=r.get(v[o].typeName);null===e||void 0===e||e.set(v[o].feature.attributes[B],v[o].feature)}else{const e=new Map;e.set(v[o].feature.attributes[B],v[o].feature),r.set(v[o].typeName,e)}h.set(v[o].feature.attributes[B],v[o].feature);const e=(0,p.Ux)(v[o].feature.attributes[j]);this.entityLinkChartDiagramLookup.set(v[o].feature.attributes[B],v[o].feature.attributes[j]?e:null),this.linkChartGeohashLookup.set(v[o].feature.attributes[B],(0,d.Qj)(v[o].feature.attributes[j].y,v[o].feature.attributes[j].x,P)),v[o].feature.attributes[j].x<M.xmin&&(M.xmin=v[o].feature.attributes[j].x),v[o].feature.attributes[j].x>M.xmax&&(M.xmax=v[o].feature.attributes[j].x),v[o].feature.attributes[j].y<M.ymin&&(M.ymin=v[o].feature.attributes[j].y),v[o].feature.attributes[j].y>M.ymax&&(M.ymax=v[o].feature.attributes[j].y)}if(this.linkChartExtent.xmin=M.xmin,this.linkChartExtent.xmax=M.xmax,this.linkChartExtent.ymin=M.ymin,this.linkChartExtent.ymax=M.ymax,!C)throw new o.A("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const I=new Map,E=new Map,A=new Map,D=new Set;for(let o=0;o<a.length;o++){const e=[],t=a[o],i=t.feature.attributes[G],n=t.feature.attributes[F],r=i+"-"+n,d=L.get(r).get(t.typeName),c=0===d?0:null===C||void 0===C?void 0:C.vertexEndIndex[d-1];if(!D.has(d)){var N,R;if(D.add(d),C.types[d]===fe.Recursive){const t=[C.vertices[2*c],C.vertices[2*c+1]],i=[C.vertices[2*(c+1)],C.vertices[2*(c+1)+1]],n=[.5*(t[0]+i[0]),.5*(t[1]+i[1])],a=[n[0]-t[0],n[1]-t[1]],o=[n[0]+a[1],n[1]-a[0]],s=[n[0]-a[1],n[1]+a[0]];e.push(t),e.push(o),e.push(i),e.push(s),e.push(t)}else{if(C.types[d]!==fe.Regular){s.A.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let t=c;t<C.vertexEndIndex[d];t++)e.push([C.vertices[2*t],C.vertices[2*t+1]])}const t=null===(N=v[u.get(i)])||void 0===N?void 0:N.feature.attributes[j],a=null===(R=v[u.get(n)])||void 0===R?void 0:R.feature.attributes[j];e[0][0]===t.x&&e[0][1]===t.y||(e[0]=[t.x,t.y]),e[e.length-1][0]===a.x&&e[e.length-1][1]===a.y||(e[e.length-1]=[a.x,a.y]);for(let i=1;i<e.length-1;i++)e[i][1]>85.5?e[i][1]=85.5:e[i][1]<-85.5&&(e[i][1]=-85.5),e[i][0]>179.9999?e[i][0]=179.9999:e[i][0]<-179.9999&&(e[i][0]=-179.9999);I.has(r)?I.get(r).push(e):I.set(r,[e])}const y=I.get(r);E.has(r)||(E.set(r,new Map),A.set(r,new Map));const m=E.get(r),f=A.get(r);m.has(t.typeName)||(m.set(t.typeName,y.shift()),f.set(t.typeName,0));const g=m.get(t.typeName);f.set(t.typeName,f.get(t.typeName)+1);const M=new re.A({paths:g});if(t.feature.attributes[j]=M,l.has(t.typeName)){const e=l.get(t.typeName);null===e||void 0===e||e.set(t.feature.attributes[B],t.feature)}else{const e=new Map;e.set(t.feature.attributes[B],t.feature),l.set(t.typeName,e)}h.set(t.feature.attributes[B],t.feature);const _=(0,p.Ux)(t.feature.attributes[j]);this.relationshipLinkChartDiagramLookup.set(t.feature.attributes[B],t.feature.attributes[j]?_:null),this.linkChartGeohashLookup.set(t.feature.attributes[B],"")}for(const o of a){var q,Z;o.feature.attributes[O]=null!==(q=null===(Z=A.get(o.feature.attributes[G]+"-"+o.feature.attributes[F]))||void 0===Z?void 0:Z.get(o.typeName))&&void 0!==q?q:null}return this._currentLinkChartConfig={layoutMode:e},{nodes:r,links:l,idMap:h}}async applyNewLinkChartLayout(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"RADIAL_TREE",t=arguments.length>1?arguments[1]:void 0;const i=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{i.push(e.refreshCachedQueryEngine())})),await Promise.all(i),this._refreshNamedTypes()}getCurrentNodeLocations(){var e;const t=new Map;return null!==(e=this.dataManager.inclusionModeDefinition)&&void 0!==e&&null!==(e=e.namedTypeDefinitions)&&void 0!==e&&e.forEach((e=>{var i;null===e||void 0===e||null===(i=e.members)||void 0===i||i.forEach((e=>{const i=e.linkChartLocation;let n;const a=e.id;i&&(n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]},t.set(a,new Ie.A({x:n.x,y:n.y})))}))})),t}async synchronizeInclusionListWithCache(){return new Promise((e=>{var t;null!==(t=this.dataManager.inclusionModeDefinition)&&void 0!==t&&t.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const i=new Set(Array.from(this.dataManager.sublayerCaches.get(t).keys()));Array.from(e.members.keys()).filter((e=>!i.has(e))).forEach((t=>{var i;null===(i=e.members)||void 0===i||i.delete(t)}))}})),e()}))}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach((e=>{t.push(e.refreshCachedQueryEngine())})),await Promise.all(t),this._refreshNamedTypes()}async _handleNewRecords(e){const t=[];this.dataManager.addToLayer(e);for(const i of e)this.sublayerIdsCache.has(i.typeName)||(this.sublayerIdsCache.set(i.typeName,new Set),t.push(i.typeName)),this.sublayerIdsCache.get(i.typeName).add(i.id);for(const i of t)if(this._graphTypeLookup.has(i)){const e=this._graphTypeLookup.get(i),t="endPoints"in e?"relationship":"entity",n=new de({objectType:e,parentCompositeLayer:this,graphType:t,title:i});"entity"===t?this.dataManager.entityTypeNames.add(i):this.dataManager.relationshipTypeNames.add(i),n.geometryType?this.layers.push(n):this.tables.push(n),this.dataManager.sublayerCaches.set(i,new Map)}await this.dataManager.refreshCacheContent(e.map((e=>e.id))),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode)}async _initializeDiagram(){var e;this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(null!==(e=this.dataManager.inclusionModeDefinition)&&void 0!==e&&null!==(e=e.namedTypeDefinitions)&&void 0!==e&&e.forEach(((e,t)=>{var i;null===e||void 0===e||null===(i=e.members)||void 0===i||i.forEach((e=>{const i=e.linkChartLocation;let n;const a=e.id;if(!i)return;n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]};const o=(0,p.Ux)(n);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(a,o):this.entityLinkChartDiagramLookup.set(a,o),this.linkChartGeohashLookup.set(a,(0,d.Qj)(n.x,n.y,P)),this.linkChartExtent.xmin>n.x&&(this.linkChartExtent.xmin=n.x),this.linkChartExtent.xmax<n.x&&(this.linkChartExtent.xmax=n.x),this.linkChartExtent.ymin>n.y&&(this.linkChartExtent.ymin=n.y),this.linkChartExtent.ymax<n.y&&(this.linkChartExtent.ymax=n.y)}))})),this.memberRelationshipTypes.forEach((e=>{var t;e.name&&(null===(t=this.dataManager.sublayerCaches.get(e.name))||void 0===t||t.forEach((e=>{const t=this.relationshipLinkChartDiagramLookup.get(e.attributes[G]),i=this.relationshipLinkChartDiagramLookup.get(e.attributes[F]);if(t&&i){const n=(0,p.Ux)(new re.A({paths:[[t.coords[0],t.coords[1]],[i.coords[0],i.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(e.attributes[B],n)}else this.relationshipLinkChartDiagramLookup.set(e.attributes[B],null);this.linkChartGeohashLookup.set(e.attributes[B],"")})))}))):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}};(0,n._)([(0,l.MZ)()],Ee.prototype,"dataPreloadedInLocalCache",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"defaultLinkChartConfig",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"dataManager",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"knowledgeGraph",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"layers",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"entityLinkChartDiagramLookup",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"relationshipLinkChartDiagramLookup",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"linkChartExtent",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"linkChartGeohashLookup",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"memberEntityTypes",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"memberRelationshipTypes",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"sublayerIdsCache",void 0),(0,n._)([(0,l.MZ)()],Ee.prototype,"tables",void 0),(0,n._)([(0,l.MZ)({json:{read:!1}})],Ee.prototype,"type",void 0),Ee=(0,n._)([(0,h.$)("esri.layers.LinkChartLayer")],Ee);const Ae=Ee},33328:(e,t,i)=>{i.d(t,{F:()=>l});var n=i(81806),a=i(70373),o=i(2413);const s={minX:0,minY:0,maxX:0,maxY:0};function r(e,t,i){(function(e){s.minX=e[0],s.minY=e[1],s.maxX=e[2],s.maxY=e[3]})(t),e.search(s,i)}class l{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new a.w(9,(0,n.A)("esri-csp-restrictions")?e=>({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const e=new Array(this._idByBounds.size);let t=0;this._idByBounds.forEach(((i,n)=>{e[t++]=n})),this._indexInvalid=!1,this._index.clear(),this._index.load(e)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter((e=>this._idByBounds.has(e)))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const e=(0,o.Ie)();for(const t of this._boundsById.values())t&&(e[0]=Math.min(t[0],e[0]),e[1]=Math.min(t[1],e[1]),e[2]=Math.max(t[2],e[2]),e[3]=Math.max(t[3],e[3]));return e}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(e){const t=this._boundsById.get(e);this._boundsById.delete(e),t&&(this._idByBounds.delete(t),this._indexInvalid||this._index.remove(t))}forEachInBounds(e,t){this._loadIndex(),r(this._index,e,(e=>t(this._idByBounds.get(e))))}get(e){return this._boundsById.get(e)}has(e){return this._boundsById.has(e)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(e,t){if(!this._indexInvalid){const t=this._boundsById.get(e);t&&(this._index.remove(t),this._idByBounds.delete(t))}this._boundsById.set(e,t),t&&(this._idByBounds.set(t,e),this._indexInvalid||(this._boundsToLoad.push(t),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},72547:(e,t,i)=>{i.d(t,{A:()=>y});var n=i(18690),a=i(50076),o=i(54099),s=i(76460),r=i(42294),l=i(2413),h=i(98618),d=i(33328),u=i(55167),p=i(33376);const c=(0,r.vt)();class y{constructor(e){this.geometryInfo=e,this._boundsStore=new d.F,this._featuresById=new Map,this._markedIds=new Set,this.events=new o.A,this.featureAdapter=p.T}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach((t=>{null!=t.geometry&&t.geometry.coords&&(e+=t.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(null==this.fullBounds)return null;const[t,i,n,a]=this.fullBounds;return{xmin:t,ymin:i,xmax:n,ymax:a,spatialReference:(0,u.ag)(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}upsertMany(e){const t=e.map((e=>this._upsert(e)));return this._emitChanged(),t.filter(n.Ru)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(const i of e){const e=this._boundsStore.get(i.objectId);e&&t((0,r.Jt)(c,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach((t=>e(t)))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,(e=>{t(this._featuresById.get(e))}))}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let e=!1;this._featuresById.forEach(((t,i)=>{this._markedIds.has(i)||(e=!0,this._remove(t))})),this._markedIds.clear(),e&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(e){var t;if(!e)return;const i=e.objectId;if(null==i)return void s.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new a.A("featurestore:invalid-feature","feature id is missing",{feature:e}));const n=this._featuresById.get(i);let o;if(this._markedIds.add(i),n?(e.displayId=n.displayId,o=this._boundsStore.get(i),this._boundsStore.delete(i)):null!=this.onFeatureAdd&&this.onFeatureAdd(e),null===(t=e.geometry)||void 0===t||null===(t=t.coords)||void 0===t||!t.length)return this._boundsStore.set(i,null),void this._featuresById.set(i,e);o=(0,h.jQ)(null!=o?o:(0,l.vt)(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=o&&this._boundsStore.set(i,o),this._featuresById.set(i,e)}_upsert(e){var t;const i=null===e||void 0===e?void 0:e.objectId;if(null==i)return s.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new a.A("featurestore:invalid-feature","feature id is missing",{feature:e})),null;const n=this._featuresById.get(i);if(!n)return this._add(e),e;this._markedIds.add(i);const{geometry:o,attributes:r}=e;for(const a in r)n.attributes[a]=r[a];return o&&(n.geometry=o,this._boundsStore.set(i,null!==(t=(0,h.jQ)((0,l.vt)(),o,this.geometryInfo.hasZ,this.geometryInfo.hasM))&&void 0!==t?t:null)),n}_remove(e){null!=this.onFeatureRemove&&this.onFeatureRemove(e);const t=e.objectId;return this._markedIds.delete(t),this._boundsStore.delete(t),this._featuresById.delete(t),e}}},40296:(e,t,i)=>{i.d(t,{F0:()=>l,Vx:()=>u,e2:()=>p,f:()=>c});var n=i(89379),a=i(81806),o=i(53084),s=i(8298),r=i(44460);function l(e){return{renderer:{type:"simple",symbol:"esriGeometryPoint"===e||"esriGeometryMultipoint"===e?r.Cb:"esriGeometryPolyline"===e?r.yM:r.WR}}}const h=/^[_$a-zA-Z][_$a-zA-Z0-9]*$/;let d=1;function u(e,t){if((0,a.A)("esri-csp-restrictions"))return()=>(0,n.A)({[t]:null},e);try{let i="this.".concat(t," = null;");for(const t in e)i+="this".concat(h.test(t)?".".concat(t):'["'.concat(t,'"]')," = ").concat(JSON.stringify(e[t]),";");const n=new Function("\n      return class AttributesClass$".concat(d++," {\n        constructor() {\n          ").concat(i,";\n        }\n      }\n    "))();return()=>new n}catch(i){return()=>(0,n.A)({[t]:null},e)}}function p(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return[{name:"New Feature",description:"",prototype:{attributes:(0,o.o8)(e)}}]}function c(e,t){return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:e},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:t,supportsDelete:t,supportsEditing:t,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:t,supportsExceedsLimitStatistics:!0,supportsAsyncConvert3D:!1},query:s.F,queryRelated:{supportsCount:!0,supportsOrderBy:!0,supportsPagination:!0,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsGeometryUpdate:t,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}},9505:(e,t,i)=>{i.d(t,{A:()=>h});var n=i(35143),a=(i(35238),i(46053)),o=(i(81806),i(76460),i(47249),i(85842)),s=i(27544),r=i(13904);let l=class extends s.A{constructor(e){super(e),this.layoutGeometry=null}};(0,n._)([(0,a.MZ)({type:r.A,json:{write:!0}})],l.prototype,"layoutGeometry",void 0),l=(0,n._)([(0,o.$)("esri.rest.knowledgeGraph.Entity")],l);const h=l},27544:(e,t,i)=>{i.d(t,{A:()=>l});var n=i(35143),a=i(46053),o=(i(81806),i(76460),i(47249),i(85842)),s=i(12831);let r=class extends s.A{constructor(e){super(e),this.typeName=null,this.id=null}};(0,n._)([(0,a.MZ)({type:String,json:{write:!0}})],r.prototype,"typeName",void 0),(0,n._)([(0,a.MZ)({type:String,json:{write:!0}})],r.prototype,"id",void 0),r=(0,n._)([(0,o.$)("esri.rest.knowledgeGraph.GraphNamedObject")],r);const l=r},12831:(e,t,i)=>{i.d(t,{A:()=>l});var n=i(35143),a=i(42553),o=i(46053),s=(i(81806),i(76460),i(47249),i(85842));let r=class extends a.oY{constructor(e){super(e),this.properties=null}};(0,n._)([(0,o.MZ)({json:{write:!0}})],r.prototype,"properties",void 0),r=(0,n._)([(0,s.$)("esri.rest.knowledgeGraph.GraphObject")],r);const l=r},35380:(e,t,i)=>{i.d(t,{A:()=>d});var n=i(35143),a=i(46053),o=(i(81806),i(76460),i(47249),i(85842)),s=i(91967);let r=class extends s.A{constructor(e){super(e),this.openCypherQuery=""}};(0,n._)([(0,a.MZ)()],r.prototype,"openCypherQuery",void 0),r=(0,n._)([(0,o.$)("esri.rest.knowledgeGraph.GraphQuery")],r);const l=r;let h=class extends l{constructor(e){super(e),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null,this.outputSpatialReference=null}};(0,n._)([(0,a.MZ)()],h.prototype,"bindParameters",void 0),(0,n._)([(0,a.MZ)()],h.prototype,"bindGeometryQuantizationParameters",void 0),(0,n._)([(0,a.MZ)()],h.prototype,"outputQuantizationParameters",void 0),(0,n._)([(0,a.MZ)()],h.prototype,"outputSpatialReference",void 0),h=(0,n._)([(0,o.$)("esri.rest.knowledgeGraph.GraphQueryStreaming")],h);const d=h},38156:(e,t,i)=>{i.d(t,{A:()=>r});var n=i(35143),a=(i(76460),i(81806),i(47249),i(50076),i(85842)),o=i(12831);let s=class extends o.A{constructor(e){super(e)}};s=(0,n._)([(0,a.$)("esri.rest.knowledgeGraph.ObjectValue")],s);const r=s},68325:(e,t,i)=>{i.d(t,{A:()=>h});var n=i(35143),a=i(42553),o=i(46053),s=(i(81806),i(76460),i(47249),i(85842)),r=i(12831);let l=class extends a.oY{constructor(e){super(e),this.path=null}};(0,n._)([(0,o.MZ)({type:[r.A],json:{write:!0}})],l.prototype,"path",void 0),l=(0,n._)([(0,s.$)("esri.rest.knowledgeGraph.Path")],l);const h=l},23908:(e,t,i)=>{i.d(t,{A:()=>h});var n=i(35143),a=(i(35238),i(46053)),o=(i(81806),i(76460),i(47249),i(85842)),s=i(27544),r=i(23701);let l=class extends s.A{constructor(e){super(e),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};(0,n._)([(0,a.MZ)({type:String,json:{write:!0}})],l.prototype,"originId",void 0),(0,n._)([(0,a.MZ)({type:String,json:{write:!0}})],l.prototype,"destinationId",void 0),(0,n._)([(0,a.MZ)({type:r.A,json:{write:!0}})],l.prototype,"layoutGeometry",void 0),l=(0,n._)([(0,o.$)("esri.rest.Relationship.Relationship")],l);const h=l}}]);
//# sourceMappingURL=6050.af2211a6.chunk.js.map